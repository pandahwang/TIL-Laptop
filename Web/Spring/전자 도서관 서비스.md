# 전자 도서관 서비스 설계  
관리자 회원가입 기능, DB 연동, 데이터 암호화 기능 구현  

구현할 관리자 기능 목록  
![alt text](images/image-16.png)  

구현할 사용자 기능 목록  
![alt text](images/image-17.png)  

## 구조  

--- 

### 회원가입 기능  

#### AdminHomeController  

@RequestMapping으로 받은 경로마다 Controller를 다르게 사용하도록 만들어줌.  

```java
package com.office.library.admin;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

@Controller
@RequestMapping("/admin") // /library/admin <-- AdminHomeController
public class AdminHomeController {
	
	private String nextPage;
	
	public AdminHomeController() {
		this.nextPage = null;
	}
	
	@RequestMapping(value = {"","/"}, method = RequestMethod.GET)	// /library/admin or /library/admin/
	public String home() {
		System.out.println("[AdminHomeController] home()");
		
		this.nextPage = "admin/home";
		return nextPage;
	}
}
```

#### AdminMemberController  

```java
@Controller
@RequestMapping("/admin/member")
public class AdminMemberController {
	
	// view 페이지를 공유하는 멤버 변수
	private String nextPage;
	
	@Autowired
    private AdminMemberService adminMemberService;
	
	public AdminMemberController() {
		this.nextPage = null;
	}

	// 회원가입사이트 요청이 들어오면 회원가입 양식 페이지를 반환  
	@RequestMapping(value = "/createAccountForm", method = RequestMethod.GET)
	public String createAccountForm()
	{
		System.out.println("[AdminMemberController] createAccountForm()");
		this.nextPage = "admin/member/create_account_form";
		
		return this.nextPage;
	}
	
	// 회원가입
	@RequestMapping(value="/createAccountConfirm", method = RequestMethod.POST)
	public String createAccountConfirm(AdminMemberVo adminMemberVo) {
		System.out.println("[AdminMemberController] createAccountConfirm()");
		
		this.nextPage = "admin/member/create_account_ok";
		
		int result = adminMemberService.createAccountConfirm(adminMemberVo);
        if(result <= 0) { this.nextPage = "admin/member/create_account_ng"; }
		
		return this.nextPage;
	}
	
}
```

#### AdminMemberService  

```java
@Service // @Component // @Repository
public class AdminMemberService {
	
	// 결과값을 상수로 지정해놓음으로써, 나중에 코드를 다시 확인할 때 한 눈에 알아볼 수 있도록 함 
	public final static int ADMIN_ACCOUNT_ALREADY_EXIST = 0;
	public final static int ADMIN_ACCOUNT_CREATE_SUCCESS = 1;
	public final static int ADMIN_ACCOUNT_CREATE_FAIL = -1;
	
	@Autowired
	private AdminMemberDao adminMemberDao;
	
	
	// DB에 입력 데이터를 넣기 전에 중복 확인 결과를 반환
    public int createAccountConfirm(AdminMemberVo adminMemberVo) {
        System.out.println("[AdminMemberService] createAccountConfirm()");
        
        boolean isMember = adminMemberDao.isAdminMember(adminMemberVo.getA_m_id());
        
        if(!isMember) {
        int result = adminMemberDao.insertAdminAccount(adminMemberVo);
	        if(result > 0) return ADMIN_ACCOUNT_CREATE_SUCCESS;
	        else {
	        	if(result == 0) return ADMIN_ACCOUNT_ALREADY_EXIST;
	        }
	        return ADMIN_ACCOUNT_CREATE_FAIL;
        }
    }
}
```

#### AdminMemberDao  


- 데이터 추간데 왜 insert 아니고 update 씀?  
jdbcTemplate에는 insert, update, delete 기능들은 모두 update로 이루어짐  
https://stackoverflow.com/questions/38225229/why-there-is-no-insert-in-spring-jdbctemplate  



## jsp 태그 설명  

`<jsp:include page="파일" />` : 지정한 파일을 페이지 내에 추가함.  
워터마크처럼 공통적으로 넣을 내용들을 따로 만들어 추가하는 것.  

```jsp
<jsp:include page="../include/title.jsp" />
```

메서드만 따로 작성하여 포함시킬 수도 있음.  

![alt text](images/js.jsp.png)  

## DB  
MariaDB 10.11.2-winx64 버전  

AUTO_INCREMENT를 사용하면 ORACLE에서의 시퀀스를 더 간편하게 사용할 수 있음.  

시퀀스가 뭔지 기억이 안나요?  

---

  `시퀀스(SEQUENCE)`  
  오라클 데이터베이스에서, 특정 규칙에 맞는 연속 숫자를 생성하는 객체.  
  ```SQL
  CREATE SEQUENCE sequence_name 
  [INCREMENT BY] 
  [START WITH]
  [MAXVALUE n | NOMAXVALUE]
  [MINVALUE n | NOMINVALUE]
  [CYCLE | NOCYCLE]
  [CACHE n | NOCACHE]
  ```

---

DB를 Java로 제어하려면 JDBC가 필요함.  



### JDBC  
Java DataBase Controller  
Java를 통해 DB를 관리할 수 있도록 연결해주는 것.  

JDBC 템플릿을 통해 간편하게 사용할 수 있음.  

`MyBatis`는 JDBC를 좀 더 편하게 쓸 수 있도록 도와줌.  
`JPA`는 더더 편하게 Java 코드만으로 DB를 관리할 수 있음.  

JDBC를 사용하려면 드라이버, DB의 주소, ID, PW가 필요함.  
이를 Maven이라면 pom.xml에 드라이버를, jdbc-context.xml에 접속 관련 정보들을 적어 넣어줘야함.  


우선 Maven 기준으로, pom.xml에 jdbc와 mariadb 템플릿을 아래와 같이 적어 설치하자.  
```xml
		<!-- Spring JDBC -->        
		<dependency>
			<groupId>org.springframework</groupId>
			<artifactId>spring-jdbc</artifactId>
			<version>${org.springframework-version}</version>
		</dependency>
		<!-- mariaDB Driver -->
		<dependency>
			<groupId>org.mariadb.jdbc</groupId>
			<artifactId>mariadb-java-client</artifactId>
			<version>3.1.2</version>
		</dependency>
```

그리고 main/webapp/WEB-INF/spring 에 xml파일을 생성하여 아래와 같은 내용을 넣어줌.  

```xml
<!-- jdbc-context.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:jdbc="http://www.springframework.org/schema/jdbc"
    xmlns:context="http://www.springframework.org/schema/context"
    xmlns:mybatis-spring="http://mybatis.org/schema/mybatis-spring"
    xmlns:tx="http://www.springframework.org/schema/tx"
    xsi:schemaLocation="http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc-4.3.xsd
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.3.xsd
        http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-4.3.xsd">
        
<!-- <context:property-placeholder
location="WEB-INF/spring/property/real.info.properties" /> -->
      
<!-- MariaDB connection 객체 -->
<bean id="dataSource"
class="org.springframework.jdbc.datasource.DriverManagerDataSource">
	<property name="driverClassName" value="org.mariadb.jdbc.Driver" />
	<property name="url" value="jdbc:mariadb://127.0.0.1:3306/db_library" />
	<property name="username" value="root" />
	<property name="password" value="1234" />
</bean>      

<!-- JdbcTemplate 객체 -->
<bean id="jdbcTemplate" class="org.springframework.jdbc.core.JdbcTemplate">
	<property name="dataSource" ref="dataSource" />
</bean>

<!-- TransactionManager 객체 -->
<bean id="transactionManager"
class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
	<property name="dataSource" ref="dataSource" />
</bean>
</beans>
```

작성하고 꼭 Maven Update Project를 해주자!!  

연결을 위한 설정을 한 거임  
그리고 이 파일들을 Spring에서 읽을 수 있도록 web.xml에 경로를 추가해줘야 함.  

```xml
	<context-param>
		<param-name>contextConfigLocation</param-name>
		<param-value>
		/WEB-INF/spring/root-context.xml
		<!-- 아래 내용을 추가해줌 -->
		/WEB-INF/spring/jdbc-context.xml</param-value>
	</context-param>
	
```

### BCryptPasswordEncoder  

스프링 시큐리티(Spring Seurity) 프레임워크에서 제공하는 클래스 중 하나로 비밀번호를 암호화하는 데 사용할 수 있는 메서드를 가진 클래스입니다.  

https://kimvampa.tistory.com/129  

마찬가지로 사용하려면 xml 파일을 추가해줘야함.  

pom.xml에 아래 내용을 추가해줌.  
```xml
		<!-- Spring security -->
		<dependency>
			<groupId>org.springframework.security</groupId>
			<artifactId>spring-security-core</artifactId>
			<version>${org.springframework-version}</version>
		</dependency>
```
main/webapp/WEB-INF/spring 에 xml파일을 생성하여 아래와 같은 내용을 넣어줌.  

```xml
<!-- security-context.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:context="http://www.springframework.org/schema/context"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.3.xsd">

	<bean id="bCryptPasswordEncoder"
	class="org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder" />
	
</beans>
```

web.xml에도 파일 경로를 추가해줌.  

```xml
	<context-param>
		<param-name>contextConfigLocation</param-name>
		<param-value>
		/WEB-INF/spring/root-context.xml
		/WEB-INF/spring/jdbc-context.xml
		<!-- 아래에 추가 -->
		/WEB-INF/spring/security-context.xml</param-value>
```

회원가입을 하면 비밀번호가 암호화되어 저장되는 것을 볼 수 있음.  

![alt text](images/createSuperAdmin.PNG)  

![alt text](images/createdSuperAdmin.PNG)  

---

## 로그인 기능  

AdminMemberController.java  
```java
	@GetMapping("/loginForm")
	public String loginForm() {
		System.out.println("[AdminMemberController] loginForm()");
		
		this.nextPage = "admin/member/login_form";
		return this.nextPage;
	}
	
	@PostMapping("/loginConfirm")
	public String loginConfirm(AdminMemberVo adminMemberVo)
	{
		System.out.println("[AdminMemberController] loginConfirm()");
		
		this.nextPage = "admin/member/login_ok";
		
		AdminMemberVo loggedAdminMemberVo = adminMemberService.loginConfirm(adminMemberVo);
		
		if(loggedAdminMemberVo == null)
		{
			this.nextPage = "admin/member/login_ng";
		}
		
		return this.nextPage;
	}
```

AdminMemberService.java
```java

	// 로그인한 adminMemberVo를 Dao의 selectAdmin으로 넘긴 후, 반환된 값을 loggedAdminMemberVo에 담아 반환
	public AdminMemberVo loginConfirm(AdminMemberVo adminMemberVo) {
		System.out.println("[AdminMemberService] loginConfirm");
		AdminMemberVo loggedAdminMemberVo = adminMemberDao.selectAdmin(adminMemberVo);
		if(loggedAdminMemberVo != null) {
			System.out.println("[AdminMemberService] ADMIN MEMBER LOGIN SUCCESS!");
		}else {
			System.out.println("[AdminMemberService] ADMIN MEMBER LOGIN FAIL!");
		}
		return loggedAdminMemberVo;
	}

```

AdminMemberDao.java  
```java
	public AdminMemberVo selectAdmin(AdminMemberVo adminMemberVo) {
		System.out.println("[AdminMemberDao] selectAdmin");
		
		String sql = "SELECT * FROM tbl_admin_member WHERE a_m_id = ? AND a_m_approval > 0";
		// 딱 한개의 튜플만 가져온다는 보장이 없기 때문에 List로 담아옴.
		List<AdminMemberVo> adminMemberVos = new ArrayList<>();

		try {
			adminMemberVos = jdbcTemplate.query(sql, adminMemberRowMapper, adminMemberVo.getA_m_id());
			if(!passwordEncoder.matches(adminMemberVo.getA_m_pw(), adminMemberVos.get(0).getA_m_pw())) {
				// passwordEncoder.matches : 암호화를 하면서 로그인 정보와, DB에서 select하여 가져온 계정의 비밀번호를 비교하는 메서드
				adminMemberVos.clear();
				// 비밀번호가 맞지 않으면 리스트를 초기화
			}
		} catch(Exception e) {e.printStackTrace();}
		
		return adminMemberVos.size() > 0 ? adminMemberVos.get(0) : null;
		// 비밀번호가 일치하면 select한 계정 리스트의 0번 인덱스 값을, 일치하지 않으면 null을 반환
```

AdminMemberRowMapper.java  
```java
@Component
public class AdminMemberRowMapper implements RowMapper<AdminMemberVo> {
	
		// mapRow가 뭐하는 거냐면, 데이터의 값들을 하나하나 가져오는 메서드임. 
		@Override
		public AdminMemberVo mapRow(ResultSet rs, int rowNum) throws SQLException{
			
			AdminMemberVo adminMemberVo = new AdminMemberVo();
			
			adminMemberVo.setA_m_no(rs.getInt("a_m_no"));
			adminMemberVo.setA_m_approval(rs.getInt("a_m_approval"));
			adminMemberVo.setA_m_id(rs.getString("a_m_id"));
			adminMemberVo.setA_m_pw(rs.getString("a_m_pw"));
			adminMemberVo.setA_m_name(rs.getString("a_m_name"));
			adminMemberVo.setA_m_gender(rs.getString("a_m_gender"));
			adminMemberVo.setA_m_part(rs.getString("a_m_part"));
			adminMemberVo.setA_m_position(rs.getString("a_m_position"));
			adminMemberVo.setA_m_mail(rs.getString("a_m_mail"));
			adminMemberVo.setA_m_phone(rs.getString("a_m_phone"));
			adminMemberVo.setA_m_reg_date(rs.getString("a_m_reg_date"));
			adminMemberVo.setA_m_mod_date(rs.getString("a_m_mod_date"));
			
			return adminMemberVo;
	}
```

---

## 로그인 상태 유지 기능  

원래는 HTTP의 비연결형과 무상태 특성으로 인해, 로그인 상태를 유지할 수 없음.  

비연결형과 무상태 특성  
장점 : 클라이언트의 수많은 요청을 서버 부하 없이 처리할 수 있음.  
단점 : 클라이언트의 요청이 발생할 때마다 서버와 매번 새로운 연결이 생성되기 때문에  
로그인 상태 유지, 장바구니 등의 기능을 구현하기 어려움.  

모든 요청들은 별개로 이루어짐.  

그럼 어떻게 합니까?  

`쿠키`와 `세션`을 통해 클라이언트와 서버의 연결 상태를 유지해줄 수 있음.  
클라이언트에서 쿠키로 연결 정보를 관리하고, 서버에서 세션으로 연결 정보를 관리함.  

---

### 쿠키

클라이언트 측에서 id와 pw를 보내면, 서버는 응답으로 `Set cookie : name/value` 이런 느낌의 데이터를 응답 헤더에 담아 보내줌.  
그 다음부터 클라이언트는 요청에 `cookie` 값을 같이 담아 제출하고, 서버는 이를 통해 사용자의 로그인 상태를 식별할 수 있음.  

`Cookie`는 유효 시간을 지정해줄 수 있음.  
아래 코드에서, cookie.setMaxAge(60*30);은 cookie의 수명을 1800초(60분)로 지정한 것임.  

수명을 지정해주지 않으면, 다른 사용자가 계정에 손쉽게 접근할 수 있게 됨.  

`HttpServletResponse` : Spring Boot의 Model과 같은 개념임.  
@PostMapping 어노테이션이 달린 메서드에 사용할 수 있는 매개변수 중 하나.  
응답 객체에 값을 실어서 보내줄 수 있음.  

```java
	@PostMapping("/loginConfirm")
	public String loginConfirm(@RequestParam("m_id") String m_id,
								@RequestParam("m_pw") String m_pw,
								HttpServletResponse response)
	{
		System.out.println("[AdminMemberController] loginConfirm()");
		
		this.nextPage = "admin/member/login_ok";
		
		if(m_id.equals("user") && m_pw.equals("1234")) 
		{
			Cookie cookie = new Cookie("loginMember", m_id);
			cookie.setMaxAge(60*30);
			response.addCookie(cookie);
		}
		else 
		{
			this.nextPage = "member/login_ng";
		}
		
		return this.nextPage;
	}
```

---  

쿠키 값을 지우는 것으로 로그아웃 기능을 구현할 수 있음.  
로그아웃 버튼을 누르면, 서버는 응답으로 쿠키를 담아 보내되, 수명을 0초로 지정하여 쿠키를 없애는 것으로 로그아웃 기능을 구현.  

`"redirect:/member/"` : /member/ 경로로 되돌려준다는 뜻  
되돌려준다는건?  
응답코드(status) 300번인 redirect는 응답에 location 속성이 있음  
redirect가 일어나면 location 속성의 값(경로)으로 다시 한 번 요청하게 됨.  



```java
	@GetMapping("/logoutForm")
	// loginMember에 계정 id가 들어가게 됨. 
	// required-false : 값이 없는 경우(쿠키 값이 없을 경우)에도 에러가 나지 않도록 함.
	public String logoutForm(@CookieValue(value="loginMember",required=false) String loginMember,
			HttpServletResponse response)
	{
		System.out.println("[MemberController] logoutForm()");
		
		this.nextPage = "redirect:/member/";
		
		Cookie cookie = new Cookie("loginMember", loginMember);		// loginMember : id
		cookie.setMaxAge(0);										// 쿠키를 받자마자 삭제되도록 함
		
		response.addCookie(cookie);									// 쿠키 내용을 응답에 담음.
		
		return this.nextPage;
	}
```

jQuery 버전
```html
<form action="<c:url value='/member/loginConfirm'/>" method="POST">
	<input type="text" name="m_id"><br>
	<input type="password" name="m_pw"><br>
	<input id="sub" type="submit" value="로그인"><br>
	<input type="reset" value="취소"><br>
</form>
<script>		
	$(document).ready(() =>{
		$("form").submit((e)=>{
			e.preventDefault();
			let form = document.querySelector('form');
			const formData = {
				m_id : form.m_id.value,
				m_pw : form.m_pw.value
			};
			$.ajax({
				url : '/cookie/member/loginConfirm',
				data : formData,
				type : 'POST',
				dataType : 'html',
				success : (response) =>{
					console.log("성공");
					document.open();
					document.write(response);
					document.close();
				},
				error : (xhr,staus, error) => {alert("화면의 문제");}
			});
		});
	});
	</script> 
```

### 세션  

세션은 서버에 접속 정보가 저장되는 방식.  
서버에 저장되기 때문에, 쿠키에 비해 보안에 강함.  

세션 ID: 클라이언트가 서버에 요청을 보내면, 서버는 클라이언트를 구분할 수 있는 ID를 생성해서 응답에 담아 전달.  
세션 ID는 브라우저가 종료되기 전까지 사용 가능.  
톰캣 환경에서, 서버는 처음 접속할 때 세션 ID를 생성하고, 이후 동일한 세션 ID로 요청을 받으면 새로운 세션 ID를 생성하지 않음.  

세션을 통해 로그인 여부에 따라 다른 화면을 보여주는 예시  

```java
	@PostMapping("/loginConfirm")
	public String loginConfirm(AdminMemberVo adminMemberVo, HttpSession session)
	{
		System.out.println("[AdminMemberController] loginConfirm()");
		
		this.nextPage = "admin/member/login_ok";
		
		AdminMemberVo loginedAdminMemberVo = adminMemberService.loginConfirm(adminMemberVo);
		
		if(loginedAdminMemberVo == null)
		{
			this.nextPage = "admin/member/login_ng";
		}
		else
		{
			session.setAttribute("loginedAdminMemberVo", loginedAdminMemberVo);
			session.setMaxInactiveInterval(60*30);
		}
		// loginedAdminMemberVo가 null인 경우, 즉 로그인에 실패한 경우 this.nextPage를 "admin/member/login_ng"로 설정합니다. 
		// 그렇지 않은 경우, 세션에 loginedAdminMemberVo 객체를 저장하고 세션의 유효 시간을 30분으로 설정합니다.
		
		return this.nextPage;
	}
```

```html
	<!-- 아래 "<%%>" 안의 내용은 Java 코드임 -->
		<%
		AdminMemberVo loginedAdminMemberVo = (AdminMemberVo) session.getAttribute("loginedAdminMemberVo");
		if (loginedAdminMemberVo != null) {
		%>
		<!-- 세션에서 로그인 정보 가져오기: 세션에서 loginedAdminMemberVo 객체를 가져옵니다. 
		 이 객체가 null이 아닌 경우, 즉 사용자가 로그인한 상태인 경우와 그렇지 않은 경우를 구분합니다. -->
		<div class="menu">
			<ul>
				<li><a href="<c:url value='/admin/member/logoutConfirm' />">로그아웃</a></li>
				<li><a href="<c:url value='/admin/member/modifyAccountForm' />">계정수정</a></li>
				
				<c:if test="${loginedAdminMemberVo.a_m_id eq 'super admin'}">
					<li><a href="<c:url value='/admin/member/listupAdmin' />">관리자목록</a></li>
				</c:if>
				
				<li><a href="<c:url value='/book/admin/getRentalBooks' />">대출도서</a></li>
				<li><a href="<c:url value='/book/admin/getAllBooks' />">전체도서</a></li>
				<li><a href="<c:url value='/book/admin/getHopeBooks' />">희망도서(입고처리)</a></li>
				<li><a href="<c:url value='/book/admin/registerBookForm' />">도서등록</a></li>
			</ul>
		</div>
		<%
		} else {
		%>
		<div class="menu">
			<ul>
				<li><a href="<c:url value='/admin/member/loginForm' />">로그인</a></li>
				<li><a href="<c:url value='/admin/member/createAccountForm' />">회원가입</a></li>
			</ul>
		</div>
		<%
		}
		%>
```

세션을 이용한 로그아웃 기능 예시  
`session.invalidate()` 메서드를 통해, 세션에 있는 사용자 정보를 무효화 시켜 로그아웃 기능을 구현함.  

```java
	@RequestMapping("/logoutConfirm")
	public String logoutConfirm(HttpSession session) {
		System.out.println("[AdminMemberController] logoutConfirm()");
		
		session.invalidate();	// 세션에 있는 사용자 정보를 무효화시킴.
		
		this.nextPage = "redirect:/admin";
		
		return this.nextPage;
	}
```

## view에 데이터를 넘겨주는 기능  

Model 객체를 통해 DB 내 데이터를 view에 전달해줄 수 있음.  

```java
	@RequestMapping("/listupAdmin")
	public String listupAdmin(Model model) {
		System.out.println("[AdminMemberController] listupAdmin()");
		
		this.nextPage = "admin/member/listup_admins";
		
		List<AdminMemberVo> adminMemberVos = adminMemberService.listupAdmin();
		
	}
```

```jsp
<table>
	<thead>
		<tr>
			<th>계정</th>
			<th>이름</th>
			<th>성별</th>
			<th>부서</th>
			<th>직무</th>
			<th>메일</th>
			<th>연락처</th>
			<th>승인</th>
		</tr>
	</thead>
	<tbody>
		<c:forEach var="item" items="${adminMemberVos}">
			<tr>
				<td>${item.a_m_id}</td>
				<td>${item.a_m_name}</td>
				<td>${item.a_m_gender}</td>
				<td>${item.a_m_part}</td>
				<td>${item.a_m_position}</td>
				<td>${item.a_m_mail}</td>
				<td>${item.a_m_phone}</td>
				<td>
					<c:choose>
						<c:when test="${item.a_m_approval eq 0}">
							<c:url value='/admin/member/setAdminApproval' var='approval_url'>
								<c:param name='a_m_no' value='${item.a_m_no}'/>
							</c:url>
							<a href="${approval_url}">승인처리</a>
						</c:when>
						<c:when test="${item.a_m_approval eq 1}"> <c:out value="승인완료" /> </c:when>
					</c:choose>
				</td>
			</tr>
		</c:forEach>
	</tbody>
</table>
```

## view를 통해 데이터를 조작하는 기능  

간단하게 SQL 문으로 조건에 맞는 데이터를 찾아, 계정 승인 값을 변경하는 예시  

AdminMemberController  
```java
	@GetMapping("/setAdminApproval")
	public String setAdminApproval(@RequestParam("a_m_no") int a_m_no)
	{
		this.nextPage = "redirect:/admin/member/listupAdmin";
		
		adminMemberService.setAdminApproval(a_m_no);
		
		return this.nextPage;
	}
```

AdminMemberService  
```java
    public void setAdminApproval(int a_m_no)
    {
    	System.out.println("[AdminMemberService] setAdminApproval()");
    	
    	int result = adminMemberDao.updateAdminAccount(a_m_no);
    }
```

AdminMemberDao  
```java
	public int updateAdminAccount(int a_m_no)
	{
		System.out.println("[AdminMemberDao] updateAdminAccount");
		
		String sql = "UPDATE tbl_admin_member SET a_m_approval = 1 WHERE a_m_no = ?";
		
		int result = -1;
		
		try {
			result = jdbcTemplate.update(sql, a_m_no);
		} catch (Exception e) {
			e.printStackTrace();
		}
		
		return result;
	}
```

## session을 통해 로그인한 계정의 정보 확인 페이지 출력 기능  

AdminMemberController  

```java
	@GetMapping("/modifyAccountForm")
	public String modifyAccountForm(HttpSession session)
	{
		System.out.println("[AdminMemberController] modifyAccountForm()");
		
		this.nextPage = "admin/member/modify_account_form";
		
		AdminMemberVo loginedAdminMemberVo = 
				(AdminMemberVo) session.getAttribute("loginedAdminMemberVo");
		
		if(loginedAdminMemberVo == null)
		{
			this.nextPage = "redirect:/admin/member/loginForm";
		}
		return this.nextPage;
	}
```

## 계정 정보 수정 기능  

AdminMemberController.java  

```java
	@GetMapping("/modifyAccountForm")
	public String modifyAccountForm(HttpSession session)
	{
		System.out.println("[AdminMemberController] modifyAccountForm()");
		
		this.nextPage = "admin/member/modify_account_form";
		
		AdminMemberVo loginedAdminMemberVo = 
				(AdminMemberVo) session.getAttribute("loginedAdminMemberVo");
		
		if(loginedAdminMemberVo == null)
		{
			this.nextPage = "redirect:/admin/member/loginForm";
		}
		return this.nextPage;
	}
	
	@PostMapping("/modifyAccountConfirm")
	public String modifyAccountConfirm(AdminMemberVo adminMemberVo, HttpSession session) {
		System.out.println("[AdminMemberController] modifyAccountConfirm");
		
		this.nextPage = "admin/member/modify_account_ok";
		
		int result = adminMemberService.modifyAccountConfirm(adminMemberVo);
		
		if(result > 0) {
			AdminMemberVo loginedAdminMemberVo
			= adminMemberService.getLoginedAdminMemberVo(adminMemberVo.getA_m_no());
			
			session.setAttribute("loginedAdminMemberVo", loginedAdminMemberVo);
			session.setMaxInactiveInterval(60*30);
		} else {
			this.nextPage = "admin/member/modify_account_ng";
		}
		return this.nextPage;
	}
```

AdminMemberService.java

```java
	public int modifyAccountConfirm(AdminMemberVo adminMemberVo) {
		System.out.println("[AdminMemberService] modifyAccountConfirm");
		
		return adminMemberDao.updateAdminAccount(adminMemberVo);
	}

	public AdminMemberVo getLoginedAdminMemberVo(int a_m_no) {
		System.out.println("[AdminMemberService] getLoginedAdminMemberVo");
		
		return adminMemberDao.selectAdmin(a_m_no);
	}
```

AdminMemberDao.java

```java
	public List<AdminMemberVo> selectAdmins(){
		System.out.println("[AdminMemberDao] selectAdmins()");
		
		String sql = "SELECT * FROM tbl_admin_member";
		
		List<AdminMemberVo> adminMemberVos = new ArrayList<>();
		
		try {
			adminMemberVos = jdbcTemplate.query(sql, adminMemberRowMapper);
		} catch (Exception e) { e.printStackTrace(); }
		return adminMemberVos;
	}

		public int updateAdminAccount(AdminMemberVo adminMemberVo)
	{
		System.out.println("[AdminMemberDao] updateAdminAccount");
		
		String sql = "UPDATE tbl_admin_member SET "
				+ "a_m_name = ?, "
				+ "a_m_gender = ?, "
				+ "a_m_part = ?, "
				+ "a_m_position = ?, "
				+ "a_m_mail = ?, "
				+ "a_m_phone = ?, "
				+ "a_m_mod_date = NOW() "
				+ "WHERE a_m_no = ?";
		int result = -1;
		try {
			result = jdbcTemplate.update(sql,
					adminMemberVo.getA_m_name(),
					adminMemberVo.getA_m_gender(),
					adminMemberVo.getA_m_part(),
					adminMemberVo.getA_m_position(),
					adminMemberVo.getA_m_mail(),
					adminMemberVo.getA_m_phone(),
					adminMemberVo.getA_m_no());
		} catch (Exception e) {
			e.printStackTrace();
		}
		return result;
	}
```

